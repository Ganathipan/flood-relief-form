<!DOCTYPE html>
<html>
<head>
  <title>Flood Relief Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body { 
      font-family: Arial, sans-serif; 
      padding: 10px; 
      background: #f0f4f7; 
      margin: 0;
    }
    h2 { 
      text-align: center; 
      font-size: 24px;
      margin: 15px 0;
    }
    h3 {
      font-size: 20px;
    }
    h4 {
      font-size: 18px;
    }
    label { 
      display: block; 
      margin-top: 15px; 
      font-weight: bold;
      font-size: 16px;
    }
    input, select, textarea {
      width: 100%; 
      padding: 14px; 
      margin-top: 5px; 
      border-radius: 8px; 
      border: 1px solid #ccc;
      font-size: 16px;
      -webkit-appearance: none;
      appearance: none;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      padding: 14px 20px; 
      margin-top: 10px;
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 8px;
      font-size: 16px; 
      cursor: pointer;
      touch-action: manipulation;
      min-height: 48px;
    }
    button:hover { background: #0056b3; }
    button:active {
      transform: scale(0.98);
    }

    /* Navigation Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      padding: 0 10px;
    }
    .tab-button {
      padding: 14px 24px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      min-height: 48px;
    }
    .tab-button:hover {
      background: #5a6268;
    }
    .tab-button.active {
      background: #007bff;
    }
    .tab-button.active:hover {
      background: #0056b3;
    }

    /* Page Content */
    .page-content {
      display: none;
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .page-content.active {
      display: block;
    }

    /* Table-style donations */
    table {
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 8px;
      background: #ffffff;
    }
    th, td {
      border: 1px solid #ccc; 
      padding: 10px;
    }
    th { 
      background: #e6edf5; 
      text-align: left;
      font-size: 16px;
    }
    td select,
    td input {
      padding: 10px;
      font-size: 16px;
    }
    .full-width-submit {
      width: 100%; 
      margin-top: 20px; 
      font-size: 18px;
      font-weight: bold;
      min-height: 52px;
    }

    /* Needs List View */
    .needs-section {
      margin-bottom: 30px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px solid #007bff;
    }
    .needs-section h4 {
      margin-top: 0;
      color: #007bff;
      font-size: 18px;
    }
    .filter-section {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .filter-section label {
      margin: 0;
      font-size: 16px;
    }
    .filter-section select {
      flex: 1;
      min-width: 150px;
      padding: 12px;
      font-size: 16px;
    }
    .filter-section button {
      padding: 12px 16px;
      font-size: 16px;
      min-height: 48px;
    }
    .needs-list {
      max-height: 400px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
    }
    .need-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: #fff;
    }
    .need-card h5 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 17px;
      line-height: 1.4;
    }
    .need-card p {
      margin: 8px 0;
      font-size: 15px;
      color: #666;
      line-height: 1.5;
    }
    .need-card .urgent {
      color: #dc3545;
      font-weight: bold;
      font-size: 15px;
    }
    .need-card .district-tag {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 8px;
    }
    .loading {
      text-align: center;
      padding: 30px 20px;
      color: #666;
      font-size: 16px;
    }

    /* Coordination Page Styles */
    .coordination-step {
      background: #f8f9fa;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .coordination-step h4 {
      margin-top: 0;
      color: #007bff;
    }
    .selection-card {
      border: 2px solid #ddd;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      transition: all 0.3s;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .selection-card:hover {
      border-color: #007bff;
      box-shadow: 0 4px 12px rgba(0,123,255,0.2);
      transform: translateY(-2px);
    }
    .selection-card.selected {
      border-color: #28a745;
      background: #e8f5e9;
    }
    .selection-card input[type="radio"] {
      margin-right: 10px;
    }
    .selection-card h4 {
      margin: 10px 0;
      color: #333;
      font-size: 18px;
    }
    .selection-card h5 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .selection-card p {
      margin: 5px 0;
      font-size: 15px;
      text-align: center;
    }
    .step-number {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      background: #007bff;
      color: white;
      border-radius: 50%;
      margin-right: 10px;
      font-weight: bold;
    }
    .summary-box {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .summary-box h5 {
      margin-top: 0;
      color: #007bff;
    }
    .btn-secondary {
      background: #6c757d;
      margin-right: 10px;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }

    /* Mobile Responsive Improvements */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }
      h2 {
        font-size: 20px;
        margin: 10px 0;
      }
      .page-content {
        padding: 15px;
        border-radius: 8px;
      }
      .selection-card {
        padding: 25px 15px;
        min-height: 140px;
      }
      .selection-card h3 {
        font-size: 40px;
      }
      .selection-card h4 {
        font-size: 16px;
      }
      .tabs {
        padding: 0 5px;
      }
      .tab-button {
        padding: 12px 16px;
        font-size: 15px;
      }
      table th,
      table td {
        padding: 8px 5px;
        font-size: 14px;
      }
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      .filter-section select,
      .filter-section button {
        width: 100%;
        min-width: auto;
      }
      .needs-section {
        padding: 12px;
      }
    }

    /* Larger touch targets for mobile */
    @media (hover: none) {
      button,
      .tab-button,
      .selection-card {
        min-height: 48px;
      }
    }
  </style>
</head>

<body>
  <h2>Flood Relief Registration System</h2>

  <!-- SELECTION PAGE (Home) -->
  <div id="selection-page" class="page-content active">
    <h3 style="text-align: center; margin-top: 0;">üè† Welcome to Flood Relief System</h3>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">Please select your role to continue</p>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; max-width: 800px; margin: 0 auto;">
      <div class="selection-card" onclick="selectRole('donor')" style="text-align: center; padding: 30px;">
        <h3 style="font-size: 48px; margin: 0;">üéÅ</h3>
        <h4 style="margin: 15px 0 10px 0; color: #007bff;">I Want to Donate</h4>
        <p style="color: #666; font-size: 14px;">Provide relief items to affected areas</p>
      </div>
      
      <div class="selection-card" onclick="selectRole('transport')" style="text-align: center; padding: 30px;">
        <h3 style="font-size: 48px; margin: 0;">üöö</h3>
        <h4 style="margin: 15px 0 10px 0; color: #007bff;">I Can Transport</h4>
        <p style="color: #666; font-size: 14px;">Help deliver supplies to those in need</p>
      </div>
      
      <div class="selection-card" onclick="selectRole('affected')" style="text-align: center; padding: 30px;">
        <h3 style="font-size: 48px; margin: 0;">üÜò</h3>
        <h4 style="margin: 15px 0 10px 0; color: #dc3545;">I Need Help</h4>
        <p style="color: #666; font-size: 14px;">Register your urgent needs</p>
      </div>
    </div>
  </div>

  <!-- DONATION/TRANSPORT PAGE -->
  <div id="donation-page" class="page-content">
    <div style="text-align: center; margin-bottom: 30px;">
      <button class="tab-button" id="donor-tab" onclick="switchDonationType('donor')" style="margin: 5px;">üéÅ Donor</button>
      <button class="tab-button" id="transport-tab" onclick="switchDonationType('transport')" style="margin: 5px;">üöö Transport Supporter</button>
    </div>

    <!-- DONOR FORM -->
    <div id="donor-form" class="page-content active">
    <h3 style="text-align: center; margin-top: 0;">Donor Registration Form</h3>

  <!-- Basic info -->
  <label>Name</label>
  <input type="text" id="name" required>

  <label>Phone Number</label>
  <input type="text" id="phone" required>

  <label>Second Phone Number (Optional)</label>
  <input type="text" id="phone2">

  <label>District</label>
  <select id="district">
    <option value="">Select District</option>
    <option>Ampara</option>
    <option>Anuradhapura</option>
    <option>Badulla</option>
    <option>Batticaloa</option>
    <option>Colombo</option>
    <option>Galle</option>
    <option>Gampaha</option>
    <option>Hambantota</option>
    <option>Jaffna</option>
    <option>Kalutara</option>
    <option>Kandy</option>
    <option>Kegalle</option>
    <option>Kilinochchi</option>
    <option>Kurunegala</option>
    <option>Mannar</option>
    <option>Matale</option>
    <option>Matara</option>
    <option>Monaragala</option>
    <option>Mullaitivu</option>
    <option>Nuwara Eliya</option>
    <option>Polonnaruwa</option>
    <option>Puttalam</option>
    <option>Ratnapura</option>
    <option>Trincomalee</option>
    <option>Vavuniya</option>
  </select>

  <!-- GPS location -->
  <label>Your GPS Location</label>
  <input type="text" id="gps" readonly placeholder="Click 'Get My Location'">
  <button type="button" onclick="getLocation()">Get My Location</button>

  <!-- Donation table -->
  <label>Donations (item + quantity)</label>
  <table id="donationTable">
    <thead>
      <tr>
        <th>Item</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody>
      <!-- first row -->
      <tr>
        <td>
          <select class="donation-item">
            <option value="">Select item</option>
            <option>Food Packs</option>
            <option>Water Bottles</option>
            <option>Clothes</option>
            <option>Medicines</option>
            <option>Sanitary Items</option>
            <option>Bedding</option>
          </select>
        </td>
        <td>
          <input type="number" class="donation-qty" min="1" placeholder="Qty">
        </td>
      </tr>
    </tbody>
  </table>
  <button type="button" onclick="addDonationRow()">+ Add another item</button>

  <label>Additional Notes (Optional)</label>
  <textarea id="notes"></textarea>

  <button class="full-width-submit" onclick="submitForm()">Submit</button>

    <!-- Needs from Affected People -->
    <div class="needs-section" style="margin-top: 30px;">
      <h4>üÜò Current Needs from Affected Areas</h4>
      <div class="filter-section">
        <label style="display: inline; margin-right: 10px;">Filter by District:</label>
        <select id="needs-filter-district" onchange="filterNeeds()">
          <option value="">All Districts</option>
          <option>Ampara</option>
          <option>Anuradhapura</option>
          <option>Badulla</option>
          <option>Batticaloa</option>
          <option>Colombo</option>
          <option>Galle</option>
          <option>Gampaha</option>
          <option>Hambantota</option>
          <option>Jaffna</option>
          <option>Kalutara</option>
          <option>Kandy</option>
          <option>Kegalle</option>
          <option>Kilinochchi</option>
          <option>Kurunegala</option>
          <option>Mannar</option>
          <option>Matale</option>
          <option>Matara</option>
          <option>Monaragala</option>
          <option>Mullaitivu</option>
          <option>Nuwara Eliya</option>
          <option>Polonnaruwa</option>
          <option>Puttalam</option>
          <option>Ratnapura</option>
          <option>Trincomalee</option>
          <option>Vavuniya</option>
        </select>
        <button type="button" onclick="loadNeeds()">üîÑ Refresh</button>
      </div>
      <div id="needs-list" class="needs-list">
        <div class="loading">Loading needs data...</div>
      </div>
    </div>
  </div>

    <!-- TRANSPORT FORM -->
    <div id="transport-form" class="page-content" style="display: none;">
    <h3 style="text-align: center; margin-top: 0;">Transport Supporter Registration</h3>

    <label>Name / Organization</label>
    <input type="text" id="transport-name" required>

    <label>Phone Number</label>
    <input type="text" id="transport-phone" required>

    <label>Second Phone Number (Optional)</label>
    <input type="text" id="transport-phone2">

    <label>Home District (Your Base Location)</label>
    <select id="transport-home-district">
      <option value="">Select Your Home District</option>
      <option>Ampara</option>
      <option>Anuradhapura</option>
      <option>Badulla</option>
      <option>Batticaloa</option>
      <option>Colombo</option>
      <option>Galle</option>
      <option>Gampaha</option>
      <option>Hambantota</option>
      <option>Jaffna</option>
      <option>Kalutara</option>
      <option>Kandy</option>
      <option>Kegalle</option>
      <option>Kilinochchi</option>
      <option>Kurunegala</option>
      <option>Mannar</option>
      <option>Matale</option>
      <option>Matara</option>
      <option>Monaragala</option>
      <option>Mullaitivu</option>
      <option>Nuwara Eliya</option>
      <option>Polonnaruwa</option>
      <option>Puttalam</option>
      <option>Ratnapura</option>
      <option>Trincomalee</option>
      <option>Vavuniya</option>
    </select>

    <label>Districts You Can Service (Select multiple - hold Ctrl/Cmd)</label>
    <select id="transport-service-districts" multiple size="8">
      <option>Ampara</option>
      <option>Anuradhapura</option>
      <option>Badulla</option>
      <option>Batticaloa</option>
      <option>Colombo</option>
      <option>Galle</option>
      <option>Gampaha</option>
      <option>Hambantota</option>
      <option>Jaffna</option>
      <option>Kalutara</option>
      <option>Kandy</option>
      <option>Kegalle</option>
      <option>Kilinochchi</option>
      <option>Kurunegala</option>
      <option>Mannar</option>
      <option>Matale</option>
      <option>Matara</option>
      <option>Monaragala</option>
      <option>Mullaitivu</option>
      <option>Nuwara Eliya</option>
      <option>Polonnaruwa</option>
      <option>Puttalam</option>
      <option>Ratnapura</option>
      <option>Trincomalee</option>
      <option>Vavuniya</option>
    </select>
    <p style="font-size: 12px; color: #666; margin-top: 5px;">üí° Tip: Hold Ctrl (Windows) or Cmd (Mac) and click to select multiple districts</p>

    <label>Vehicle Type</label>
    <select id="vehicle-type">
      <option value="">Select Vehicle Type</option>
      <option>Van</option>
      <option>Truck</option>
      <option>Lorry</option>
      <option>Three-Wheeler</option>
      <option>Car</option>
      <option>Boat</option>
      <option>Other</option>
    </select>

    <label>Vehicle Capacity (kg or number of people)</label>
    <input type="text" id="vehicle-capacity">

    <label>Your GPS Location</label>
    <input type="text" id="transport-gps" readonly placeholder="Click 'Get My Location'">
    <button type="button" onclick="getLocationTransport()">Get My Location</button>

    <label>Availability</label>
    <select id="availability">
      <option value="">Select Availability</option>
      <option>Available Now</option>
      <option>Available Today</option>
      <option>Available This Week</option>
      <option>On Request</option>
    </select>

    <label>Additional Notes (Optional)</label>
    <textarea id="transport-notes"></textarea>

    <button class="full-width-submit" onclick="submitTransportForm()">Submit</button>

    <!-- Needs from Affected People for Transport -->
    <div class="needs-section" style="margin-top: 30px;">
      <h4>üÜò Where People Need Help & Available Supplies</h4>
      <div class="filter-section">
        <label style="display: inline; margin-right: 10px;">Filter by District:</label>
        <select id="transport-needs-filter" onchange="filterTransportNeeds()">
          <option value="">All Districts</option>
          <option>Ampara</option>
          <option>Anuradhapura</option>
          <option>Badulla</option>
          <option>Batticaloa</option>
          <option>Colombo</option>
          <option>Galle</option>
          <option>Gampaha</option>
          <option>Hambantota</option>
          <option>Jaffna</option>
          <option>Kalutara</option>
          <option>Kandy</option>
          <option>Kegalle</option>
          <option>Kilinochchi</option>
          <option>Kurunegala</option>
          <option>Mannar</option>
          <option>Matale</option>
          <option>Matara</option>
          <option>Monaragala</option>
          <option>Mullaitivu</option>
          <option>Nuwara Eliya</option>
          <option>Polonnaruwa</option>
          <option>Puttalam</option>
          <option>Ratnapura</option>
          <option>Trincomalee</option>
          <option>Vavuniya</option>
        </select>
        <button type="button" onclick="loadTransportNeeds()">üîÑ Refresh</button>
      </div>
      <div id="transport-needs-list" class="needs-list">
        <div class="loading">Loading needs and available supplies...</div>
      </div>
    </div>
    </div>
  </div>

  <!-- AFFECTED PEOPLE PAGE -->
  <div id="affected-page" class="page-content">
    <h3 style="text-align: center; margin-top: 0;">Affected People Registration</h3>

    <label>Name</label>
    <input type="text" id="affected-name" required>

    <label>Phone Number</label>
    <input type="text" id="affected-phone" required>

    <label>Second Phone Number (Optional)</label>
    <input type="text" id="affected-phone2">

    <label>District</label>
    <select id="affected-district">
      <option value="">Select District</option>
      <option>Ampara</option>
      <option>Anuradhapura</option>
      <option>Badulla</option>
      <option>Batticaloa</option>
      <option>Colombo</option>
      <option>Galle</option>
      <option>Gampaha</option>
      <option>Hambantota</option>
      <option>Jaffna</option>
      <option>Kalutara</option>
      <option>Kandy</option>
      <option>Kegalle</option>
      <option>Kilinochchi</option>
      <option>Kurunegala</option>
      <option>Mannar</option>
      <option>Matale</option>
      <option>Matara</option>
      <option>Monaragala</option>
      <option>Mullaitivu</option>
      <option>Nuwara Eliya</option>
      <option>Polonnaruwa</option>
      <option>Puttalam</option>
      <option>Ratnapura</option>
      <option>Trincomalee</option>
      <option>Vavuniya</option>
    </select>

    <label>Your GPS Location</label>
    <input type="text" id="affected-gps" readonly placeholder="Click 'Get My Location'">
    <button type="button" onclick="getLocationAffected()">Get My Location</button>

    <label>Number of People Affected</label>
    <input type="number" id="people-count" min="1" required>

    <label>Urgent Needs (item + quantity)</label>
    <table id="needsTable">
      <thead>
        <tr>
          <th>Item</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <select class="need-item">
              <option value="">Select item</option>
              <option>Food Packs</option>
              <option>Water Bottles</option>
              <option>Clothes</option>
              <option>Medicines</option>
              <option>Sanitary Items</option>
              <option>Bedding</option>
              <option>Shelter</option>
              <option>Medical Help</option>
            </select>
          </td>
          <td>
            <input type="number" class="need-qty" min="1" placeholder="Qty">
          </td>
        </tr>
      </tbody>
    </table>
    <button type="button" onclick="addNeedRow()">+ Add another item</button>

    <label>Current Situation / Additional Information</label>
    <textarea id="affected-notes"></textarea>

    <button class="full-width-submit" onclick="submitAffectedForm()">Submit</button>
  </div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbxNrPQojUsPiq6P2jWC1Ea2EtWsyPN-ImOnovUmCZnbpxNgB3m4JH_OE-xQNvOBR1cjoA/exec";

    let allNeedsData = [];
    let allDonorsData = [];
    let currentRole = 'donor';

    // Role Selection
    function selectRole(role) {
      if (role === 'affected') {
        showPage('affected');
      } else {
        currentRole = role;
        showPage('donation');
        switchDonationType(role);
      }
    }

    // Switch between donor and transport in donation page
    function switchDonationType(type) {
      currentRole = type;
      
      // Update tab buttons
      document.getElementById('donor-tab').classList.remove('active');
      document.getElementById('transport-tab').classList.remove('active');
      
      if (type === 'donor') {
        document.getElementById('donor-tab').classList.add('active');
        document.getElementById('donor-form').style.display = 'block';
        document.getElementById('transport-form').style.display = 'none';
        loadNeeds();
      } else {
        document.getElementById('transport-tab').classList.add('active');
        document.getElementById('donor-form').style.display = 'none';
        document.getElementById('transport-form').style.display = 'block';
        loadTransportNeeds();
      }
    }

    // Page Navigation
    function showPage(page) {
      // Hide all pages
      document.querySelectorAll('.page-content').forEach(p => {
        if (!p.id.includes('-form')) {
          p.classList.remove('active');
        }
      });
      document.querySelectorAll('.tabs .tab-button').forEach(b => b.classList.remove('active'));

      // Show selected page
      document.getElementById(page + '-page').classList.add('active');
      event.target.classList.add('active');

      // Load data based on page
      if (page === 'donation') {
        switchDonationType(currentRole);
      }
    }

    // Load needs from affected people (for donors)
    function loadNeeds() {
      const needsList = document.getElementById('needs-list');
      needsList.innerHTML = '<div class="loading">Loading needs data...</div>';

      fetch(scriptURL + '?action=getNeeds')
        .then(res => res.json())
        .then(data => {
          allNeedsData = data;
          displayNeeds(allNeedsData);
        })
        .catch(err => {
          needsList.innerHTML = '<div class="loading">Error loading needs data. Please try again.</div>';
          console.error('Error:', err);
        });
    }

    // Display needs in the list
    function displayNeeds(needs) {
      const needsList = document.getElementById('needs-list');
      
      if (!needs || needs.length === 0) {
        needsList.innerHTML = '<div class="loading">No urgent needs reported yet.</div>';
        return;
      }

      let html = '';
      needs.forEach(need => {
        html += `
          <div class="need-card">
            <h5><span class="district-tag">${need.district}</span> ${need.name}</h5>
            <p><strong>üìû Contact:</strong> ${need.phone}</p>
            ${need.phone2 ? `<p><strong>üìû Alt:</strong> ${need.phone2}</p>` : ''}
            <p><strong>üë• People Affected:</strong> ${need.peopleCount}</p>
            <p class="urgent"><strong>üÜò Urgent Needs:</strong> ${need.needsFormatted}</p>
            ${need.gps ? `<p><strong>üìç Location:</strong> ${need.gps}</p>` : ''}
            ${need.notes ? `<p><strong>‚ÑπÔ∏è Situation:</strong> ${need.notes}</p>` : ''}
            <p style="font-size: 12px; color: #999;"><strong>Reported:</strong> ${need.timestamp}</p>
          </div>
        `;
      });

      needsList.innerHTML = html;
    }

    // Filter needs by district
    function filterNeeds() {
      const selectedDistrict = document.getElementById('needs-filter-district').value;
      
      if (!selectedDistrict) {
        displayNeeds(allNeedsData);
      } else {
        const filtered = allNeedsData.filter(need => need.district === selectedDistrict);
        displayNeeds(filtered);
      }
    }

    // Load needs when page loads
    window.addEventListener('DOMContentLoaded', function() {
      loadNeeds();
    });

    // DONOR Functions
    function addDonationRow() {
      const tbody = document.querySelector("#donationTable tbody");
      const row = document.createElement("tr");
  
      row.innerHTML = `
        <td>
          <select class="donation-item">
            <option value="">Select item</option>
            <option>Food Packs</option>
            <option>Water Bottles</option>
            <option>Clothes</option>
            <option>Medicines</option>
            <option>Sanitary Items</option>
            <option>Bedding</option>
          </select>
        </td>
        <td>
          <input type="number" class="donation-qty" min="1" placeholder="Qty">
        </td>
      `;
      tbody.appendChild(row);
    }
  
    function getLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported on this device.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById("gps").value = lat + ", " + lng;
        },
        (err) => {
          alert("Unable to get location: " + err.message);
        }
      );
    }
  
    function submitForm() {
      const rows = document.querySelectorAll("#donationTable tbody tr");
      const donationsArray = [];
  
      rows.forEach(row => {
        const item = row.querySelector(".donation-item").value;
        const qty  = row.querySelector(".donation-qty").value;
  
        if (item && qty) {
          const itemNoSpace = item.replace(/\s+/g, "");
          donationsArray.push(itemNoSpace + "_" + qty + ";");
        }
      });
  
      if (donationsArray.length === 0) {
        alert("Please add at least one donation item and quantity.");
        return;
      }
  
      const donationsString = donationsArray.join("");
  
      const data = {
        type: "donor",
        name: document.getElementById("name").value,
        phone: document.getElementById("phone").value,
        phone2: document.getElementById("phone2").value,
        district: document.getElementById("district").value,
        donations: donationsString,
        gps: document.getElementById("gps").value,
        notes: document.getElementById("notes").value
      };
  
      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => {
        alert("Server says: " + text);
      })
      .catch(err => {
        alert("Error: " + err);
      });
    }

    // TRANSPORT Functions
    function getLocationTransport() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported on this device.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById("transport-gps").value = lat + ", " + lng;
        },
        (err) => {
          alert("Unable to get location: " + err.message);
        }
      );
    }

    function submitTransportForm() {
      // Get selected service districts
      const serviceDistrictsSelect = document.getElementById("transport-service-districts");
      const selectedOptions = Array.from(serviceDistrictsSelect.selectedOptions);
      const serviceDistricts = selectedOptions.map(option => option.value);
      
      if (serviceDistricts.length === 0) {
        alert("Please select at least one district you can service.");
        return;
      }

      const data = {
        type: "transport",
        name: document.getElementById("transport-name").value,
        phone: document.getElementById("transport-phone").value,
        phone2: document.getElementById("transport-phone2").value,
        homeDistrict: document.getElementById("transport-home-district").value,
        serviceDistricts: serviceDistricts.join(", "),
        vehicleType: document.getElementById("vehicle-type").value,
        vehicleCapacity: document.getElementById("vehicle-capacity").value,
        gps: document.getElementById("transport-gps").value,
        availability: document.getElementById("availability").value,
        notes: document.getElementById("transport-notes").value
      };

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => {
        alert("Server says: " + text);
      })
      .catch(err => {
        alert("Error: " + err);
      });
    }

    // AFFECTED PEOPLE Functions
    function addNeedRow() {
      const tbody = document.querySelector("#needsTable tbody");
      const row = document.createElement("tr");
  
      row.innerHTML = `
        <td>
          <select class="need-item">
            <option value="">Select item</option>
            <option>Food Packs</option>
            <option>Water Bottles</option>
            <option>Clothes</option>
            <option>Medicines</option>
            <option>Sanitary Items</option>
            <option>Bedding</option>
            <option>Shelter</option>
            <option>Medical Help</option>
          </select>
        </td>
        <td>
          <input type="number" class="need-qty" min="1" placeholder="Qty">
        </td>
      `;
      tbody.appendChild(row);
    }

    function getLocationAffected() {
      if (!navigator.geolocation) {
        alert("Geolocation is not supported on this device.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById("affected-gps").value = lat + ", " + lng;
        },
        (err) => {
          alert("Unable to get location: " + err.message);
        }
      );
    }

    function submitAffectedForm() {
      const rows = document.querySelectorAll("#needsTable tbody tr");
      const needsArray = [];
  
      rows.forEach(row => {
        const item = row.querySelector(".need-item").value;
        const qty  = row.querySelector(".need-qty").value;
  
        if (item && qty) {
          const itemNoSpace = item.replace(/\s+/g, "");
          needsArray.push(itemNoSpace + "_" + qty + ";");
        }
      });
  
      if (needsArray.length === 0) {
        alert("Please add at least one urgent need item.");
        return;
      }
  
      const needsString = needsArray.join("");
  
      const data = {
        type: "affected",
        name: document.getElementById("affected-name").value,
        phone: document.getElementById("affected-phone").value,
        phone2: document.getElementById("affected-phone2").value,
        district: document.getElementById("affected-district").value,
        gps: document.getElementById("affected-gps").value,
        peopleCount: document.getElementById("people-count").value,
        needs: needsString,
        notes: document.getElementById("affected-notes").value
      };

      fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(text => {
        alert("Server says: " + text);
      })
      .catch(err => {
        alert("Error: " + err);
      });
    }

    // Load needs and donors for transport supporters
    function loadTransportNeeds() {
      const needsList = document.getElementById('transport-needs-list');
      needsList.innerHTML = '<div class="loading">Loading needs and available supplies...</div>';

      Promise.all([
        fetch(scriptURL + '?action=getNeeds').then(res => res.json()),
        fetch(scriptURL + '?action=getDonors').then(res => res.json())
      ])
      .then(([needs, donors]) => {
        displayTransportNeeds(needs, donors);
      })
      .catch(err => {
        needsList.innerHTML = '<div class="loading">Error loading data. Please try again.</div>';
        console.error('Error:', err);
      });
    }

    function displayTransportNeeds(needs, donors) {
      const needsList = document.getElementById('transport-needs-list');
      
      if ((!needs || needs.length === 0) && (!donors || donors.length === 0)) {
        needsList.innerHTML = '<div class="loading">No data available yet.</div>';
        return;
      }

      let html = '<h5 style="color: #dc3545; margin-top: 0;">üÜò Urgent Needs:</h5>';
      
      if (needs && needs.length > 0) {
        needs.forEach(need => {
          html += `
            <div class="need-card">
              <h5><span class="district-tag">${need.district}</span> ${need.name}</h5>
              <p><strong>üìû Contact:</strong> ${need.phone}</p>
              <p><strong>üë• People Affected:</strong> ${need.peopleCount}</p>
              <p class="urgent"><strong>üÜò Needs:</strong> ${need.needsFormatted}</p>
              ${need.gps ? `<p><strong>üìç Location:</strong> ${need.gps}</p>` : ''}
            </div>
          `;
        });
      }

      html += '<h5 style="color: #28a745; margin-top: 20px;">üéÅ Available Supplies from Donors:</h5>';
      
      if (donors && donors.length > 0) {
        donors.forEach(donor => {
          html += `
            <div class="need-card" style="border-color: #28a745;">
              <h5><span class="district-tag" style="background: #28a745;">${donor.district}</span> ${donor.name}</h5>
              <p><strong>üìû Contact:</strong> ${donor.phone}</p>
              <p style="color: #28a745;"><strong>üì¶ Available:</strong> ${donor.donationsFormatted}</p>
              ${donor.gps ? `<p><strong>üìç Location:</strong> ${donor.gps}</p>` : ''}
            </div>
          `;
        });
      } else {
        html += '<div class="loading">No donations available yet.</div>';
      }

      needsList.innerHTML = html;
    }

    function filterTransportNeeds() {
      const selectedDistrict = document.getElementById('transport-needs-filter').value;
      
      Promise.all([
        fetch(scriptURL + '?action=getNeeds').then(res => res.json()),
        fetch(scriptURL + '?action=getDonors').then(res => res.json())
      ])
      .then(([needs, donors]) => {
        if (selectedDistrict) {
          needs = needs.filter(need => need.district === selectedDistrict);
          donors = donors.filter(donor => donor.district === selectedDistrict);
        }
        displayTransportNeeds(needs, donors);
      });
    }

    // Load needs on page load
    window.addEventListener('DOMContentLoaded', function() {
      switchDonationType('donor');
    });
  </script>
</body>
</html>
